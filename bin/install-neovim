#!/usr/bin/env bash

set -euo pipefail

INSTALL_DIR="$HOME/bin"
INSTALL_PATH="$INSTALL_DIR/nvim"

ARCH=$(uname -m)
case "$ARCH" in
  x86_64)
    ARCH_SUFFIX="x86_64"
    ;;
  aarch64 | arm64)
    ARCH_SUFFIX="arm64"
    ;;
  *)
    echo "âŒ Unsupported architecture: $ARCH"
    exit 1
    ;;
esac

echo "ğŸ” Fetching latest Neovim release info..."
API_URL="https://api.github.com/repos/neovim/neovim/releases/latest"
RELEASE_JSON=$(curl -fsSL "$API_URL")

TAG_NAME=$(echo "$RELEASE_JSON" | grep -oP '"tag_name":\s*"\K[^"]+')
FILENAME="nvim-linux-$ARCH_SUFFIX.appimage"
DOWNLOAD_URL="https://github.com/neovim/neovim/releases/download/$TAG_NAME/$FILENAME"

echo "ğŸ” Found latest release: $TAG_NAME"
echo "ğŸŒ Download URL: $DOWNLOAD_URL"

echo "ğŸ“¦ Downloading $FILENAME..."
curl -fLo "$FILENAME" "$DOWNLOAD_URL"

echo "ğŸ” Making it executable..."
chmod u+x "$FILENAME"

echo "ğŸ“‚ Creating $INSTALL_DIR if it doesn't exist..."
mkdir -p "$INSTALL_DIR"

echo "ğŸšš Moving to $INSTALL_PATH"
mv "$FILENAME" "$INSTALL_PATH"

echo "âœ… Neovim $TAG_NAME installed to $INSTALL_PATH"

if [[ ":$PATH:" != *":$INSTALL_DIR:"* ]]; then
  echo "âš ï¸ $INSTALL_DIR is not in your PATH."
  echo "ğŸ‘‰ Add this to your ~/.bashrc or ~/.zshrc:"
  echo "   export PATH=\"\$HOME/bin:\$PATH\""
else
  echo "ğŸš€ Verifying:"
  "$INSTALL_PATH" --version
fi

