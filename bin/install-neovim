#!/usr/bin/env bash

set -euo pipefail

INSTALL_DIR="$HOME/bin"
INSTALL_PATH="$INSTALL_DIR/nvim"

# Detect OS
OS=$(uname -s)
ARCH=$(uname -m)

case "$OS" in
  Darwin)
    # macOS
    case "$ARCH" in
      x86_64)
        FILENAME="nvim-macos-x86_64.tar.gz"
        ;;
      arm64)
        FILENAME="nvim-macos-arm64.tar.gz"
        ;;
      *)
        echo "‚ùå Unsupported macOS architecture: $ARCH"
        exit 1
        ;;
    esac
    ;;
  Linux)
    # Linux
    case "$ARCH" in
      x86_64)
        FILENAME="nvim-linux64.tar.gz"
        ;;
      aarch64 | arm64)
        FILENAME="nvim-linux-arm64.appimage"
        ;;
      *)
        echo "‚ùå Unsupported Linux architecture: $ARCH"
        exit 1
        ;;
    esac
    ;;
  *)
    echo "‚ùå Unsupported OS: $OS"
    exit 1
    ;;
esac

echo "üîç Fetching latest Neovim release info..."
API_URL="https://api.github.com/repos/neovim/neovim/releases/latest"
RELEASE_JSON=$(curl -fsSL "$API_URL")

# Use sed instead of grep -P for macOS compatibility
TAG_NAME=$(echo "$RELEASE_JSON" | sed -n 's/.*"tag_name": "\([^"]*\)".*/\1/p' | head -n1)
DOWNLOAD_URL="https://github.com/neovim/neovim/releases/download/$TAG_NAME/$FILENAME"

echo "üîé Found latest release: $TAG_NAME"
echo "üåê Download URL: $DOWNLOAD_URL"

echo "üì¶ Downloading $FILENAME..."
curl -fLo "$FILENAME" "$DOWNLOAD_URL"

echo "üìÇ Creating $INSTALL_DIR if it doesn't exist..."
mkdir -p "$INSTALL_DIR"

# Handle installation based on file type
if [[ "$FILENAME" == *.tar.gz ]]; then
  echo "üì¶ Extracting tarball..."
  tar xzf "$FILENAME"

  # Find the nvim binary in the extracted directory
  EXTRACTED_DIR=$(tar tzf "$FILENAME" | head -1 | cut -f1 -d"/")

  echo "üöö Moving to $INSTALL_PATH"
  mv "$EXTRACTED_DIR/bin/nvim" "$INSTALL_PATH"

  echo "üßπ Cleaning up..."
  rm -rf "$EXTRACTED_DIR" "$FILENAME"
elif [[ "$FILENAME" == *.appimage ]]; then
  echo "üîê Making it executable..."
  chmod u+x "$FILENAME"

  echo "üöö Moving to $INSTALL_PATH"
  mv "$FILENAME" "$INSTALL_PATH"
fi

echo "‚úÖ Neovim $TAG_NAME installed to $INSTALL_PATH"

if [[ ":$PATH:" != *":$INSTALL_DIR:"* ]]; then
  echo "‚ö†Ô∏è $INSTALL_DIR is not in your PATH."
  echo "üëâ Add this to your ~/.bashrc or ~/.zshrc:"
  echo "   export PATH=\"\$HOME/bin:\$PATH\""
else
  echo "üöÄ Verifying:"
  "$INSTALL_PATH" --version
fi

